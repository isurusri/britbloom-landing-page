"use client";

import { useEffect, useRef } from "react";
import { Fluid, Canvas, Program, FQuad } from "../src/lib/fluidsim";

import styles from "./hero.module.scss";
import { getContainRepeat, PaperKernel } from "./paper";
import { createTextureAsync } from "twgl.js";

export default function Hero() {
	const el = useRef < HTMLDivElement > (null);
	const canvas = useRef < Canvas > (null);
	const paper = useRef < PaperKernel > (null);
	const fluid = useRef < Fluid > (null);

	useEffect(() => {
		canvas.current = new Canvas();

		if (!el.current) return;

		canvas.current = new Canvas({ antialias: false });
		const { clientWidth, clientHeight } = el.current;
		canvas.current.setSize(clientWidth, clientHeight);
		el.current.appendChild(canvas.current.domElement);

		const gl = canvas.current.gl;
		paper.current = new PaperKernel(gl);

		fluid.current = new Fluid(gl, clientWidth * 0.25, clientHeight * 0.25);
		fluid.current.initUniforms();

		let fId: number;
		function animate(time: DOMHighResTimeStamp) {
			if (!fluid.current || !paper.current) return;

			fluid.current.step();

			paper.current.program.use();
			paper.current.program.uniforms.pressure = fluid.current.pressureFBO2.object.attachments[0];
			paper.current.draw();

			fId = requestAnimationFrame(animate);
		}
		fId = requestAnimationFrame(animate);

		return () => {
			cancelAnimationFrame(fId);
			if (canvas.current) el.current?.removeChild(canvas.current.domElement);
		};
	}, []);

	useEffect(() => {
		async function loadTexture() {
			if (!canvas.current) return;

			const textureInfo = await createTextureAsync(canvas.current.gl, {
				src: "/images/bg4.jpg",
				min: canvas.current.gl.LINEAR,
				mag: canvas.current.gl.LINEAR,
				flipY: canvas.current.gl.UNPACK_FLIP_Y_WEBGL,
			});

			const { width, height } = canvas.current.domElement;
			const repeat = getContainRepeat(1919, 1371, width, height);

			if (paper.current) {
				paper.current.program.use();
				paper.current.program.uniforms.textures = [
					{
						texture: textureInfo.texture,
						offset: [0, 0],
						repeat,
					},
				];
				paper.current.draw();
			}
		}

		loadTexture();
	}, []);

	useEffect(() => {
		function handleWindowResize() {
			if (!el.current) return;

			const { clientWidth, clientHeight } = el.current;
			canvas.current?.setSize(clientWidth, clientHeight);
			fluid.current?.setSize(clientWidth * 0.25, clientHeight * 0.25);
			fluid.current?.initUniforms();

			const repeat = getContainRepeat(1919, 1371, clientWidth, clientHeight);
			if (paper.current) paper.current.program.uniforms.textures[0].repeat = repeat;
		}

		window.addEventListener("resize", handleWindowResize);

		return () => {
			window.removeEventListener("resize", handleWindowResize);
		};
	}, []);

	useEffect(() => {
		function handlePointerMove({ clientX, clientY }: PointerEvent) {
			fluid.current?.setPointer([clientX * 0.25, clientY * 0.25]);
		}

		el.current?.addEventListener("pointermove", handlePointerMove);

		return () => {
			el.current?.removeEventListener("pointermove", handlePointerMove);
		};
	}, []);

	return (
		<div className={styles["wrapper"]}>
			<div className={styles["c"]}>
				<span className={styles["c-title"]}>
					<svg viewBox="0 0 200 22" fill="none" xmlns="http://www.w3.org/2000/svg">
						<title>BRITBLOOMS</title>
						<path
							d="M24.2236 0.407227H28.293C29.6102 0.407259 30.8305 0.562134 31.9541 0.87207C33.0778 1.16268 33.9791 1.67589 34.6572 2.41211C35.3545 3.14825 35.7031 4.17501 35.7031 5.49219C35.7031 6.65462 35.442 7.60461 34.9189 8.34082C34.4152 9.05767 33.7363 9.60959 32.8838 9.99707C32.0508 10.3651 31.1403 10.6263 30.1523 10.7812C31.5859 10.8781 32.7485 11.3726 33.6396 12.2637C34.5502 13.1355 35.1319 14.424 35.3838 16.1289C35.5582 17.2138 35.7706 18.0666 36.0225 18.6865C36.2936 19.287 36.5846 19.713 36.8945 19.9648C37.2239 20.1973 37.5535 20.3135 37.8828 20.3135C38.0959 20.3135 38.2994 20.2748 38.4932 20.1973C38.7061 20.1198 38.89 20.0423 39.0449 19.9648L39.249 20.6914C38.939 20.8464 38.5221 20.9923 37.999 21.1279C37.476 21.2829 36.9428 21.3604 36.4004 21.3604C35.3351 21.3603 34.5406 21.0018 34.0176 20.2852C33.5138 19.5489 33.1843 18.6476 33.0293 17.582C32.9324 16.8071 32.7776 16.0318 32.5645 15.2568C32.3707 14.482 32.051 13.775 31.6055 13.1357C31.1792 12.477 30.5688 11.9539 29.7744 11.5664C28.9996 11.179 27.9827 10.9854 26.7236 10.9854H25.4736V17.1748C25.4736 18.1239 25.5412 18.812 25.6768 19.2383C25.8124 19.6451 26.0645 19.9171 26.4326 20.0527C26.8007 20.1689 27.3141 20.2653 27.9727 20.3428L28.5537 20.4014V21.1279L24.2529 21.04H24.2236L19.9229 21.1279V20.4014L20.5039 20.3428C21.1817 20.2653 21.6952 20.1689 22.0439 20.0527C22.4121 19.9171 22.6642 19.6451 22.7998 19.2383C22.9354 18.812 23.0029 18.124 23.0029 17.1748V4.27246C23.0029 3.30395 22.9354 2.61587 22.7998 2.20898C22.6642 1.80213 22.4121 1.54007 22.0439 1.42383C21.6952 1.28829 21.1817 1.18196 20.5039 1.10449L19.9229 1.0459V0.319336L24.2236 0.407227ZM122.286 0C123.739 3.72941e-05 125.076 0.261254 126.296 0.78418C127.536 1.30728 128.602 2.04383 129.493 2.99316C130.404 3.94245 131.111 5.06628 131.614 6.36426C132.118 7.6622 132.37 9.09591 132.37 10.665C132.37 12.2343 132.118 13.6786 131.614 14.9961C131.111 16.294 130.404 17.418 129.493 18.3672C128.602 19.3164 127.536 20.0521 126.296 20.5752C125.075 21.0982 123.739 21.3603 122.286 21.3604C120.833 21.3604 119.486 21.0983 118.246 20.5752C117.026 20.0522 115.96 19.3163 115.05 18.3672C114.159 17.4179 113.461 16.294 112.957 14.9961C112.453 13.6786 112.201 12.2343 112.201 10.665C112.201 9.09591 112.453 7.6622 112.957 6.36426C113.461 5.06623 114.159 3.94247 115.05 2.99316C115.96 2.04393 117.026 1.30725 118.246 0.78418C119.486 0.261076 120.833 0 122.286 0ZM146.068 0C147.521 2.71986e-06 148.859 0.261079 150.079 0.78418C151.319 1.30725 152.384 2.04393 153.275 2.99316C154.186 3.9425 154.894 5.06619 155.397 6.36426C155.901 7.6622 156.152 9.09591 156.152 10.665C156.152 12.2343 155.901 13.6786 155.397 14.9961C154.894 16.2941 154.186 17.4179 153.275 18.3672C152.384 19.3163 151.319 20.0522 150.079 20.5752C148.859 21.0983 147.521 21.3603 146.068 21.3604C144.615 21.3604 143.269 21.0982 142.029 20.5752C140.809 20.0521 139.743 19.3164 138.832 18.3672C137.941 17.4179 137.243 16.2941 136.739 14.9961C136.236 13.6786 135.984 12.2343 135.984 10.665C135.984 9.09591 136.236 7.6622 136.739 6.36426C137.243 5.06619 137.941 3.9425 138.832 2.99316C139.743 2.04386 140.809 1.30727 142.029 0.78418C143.269 0.261238 144.616 0 146.068 0ZM193.49 0C194.285 0 194.954 0.10622 195.496 0.319336C196.039 0.532429 196.464 0.71709 196.774 0.87207C197.278 1.12387 197.675 1.24994 197.966 1.25C198.276 1.25 198.46 0.949232 198.519 0.348633H199.245L199.157 3.13867L199.216 5.95801H198.489C198.373 4.87305 198.072 3.95188 197.588 3.19629C197.104 2.42155 196.513 1.8306 195.815 1.42383C195.137 1.01701 194.411 0.813477 193.636 0.813477C192.493 0.813501 191.563 1.14306 190.846 1.80176C190.148 2.46045 189.8 3.30334 189.8 4.33008C189.8 5.43431 190.158 6.30598 190.875 6.94531C191.592 7.56529 192.522 8.1569 193.665 8.71875L194.856 9.2998C195.922 9.82282 196.832 10.365 197.588 10.9268C198.363 11.4692 198.954 12.1086 199.361 12.8447C199.788 13.5808 200 14.5013 200 15.6055C200 16.7484 199.739 17.7562 199.216 18.6279C198.712 19.4997 198.024 20.1778 197.152 20.6621C196.3 21.1271 195.341 21.3603 194.275 21.3604C193.5 21.3604 192.793 21.2343 192.153 20.9824C191.533 20.7306 190.971 20.4784 190.468 20.2266C190.042 19.9942 189.683 19.8193 189.393 19.7031C189.122 19.587 188.879 19.5293 188.666 19.5293C188.395 19.5294 188.201 19.6455 188.085 19.8779C187.988 20.091 187.911 20.3333 187.853 20.6045L187.766 21.04H187.039L187.185 17.6113L187.097 13.8623H187.823L188.144 15.2285C188.357 16.0808 188.734 16.914 189.276 17.7275C189.838 18.5412 190.536 19.2093 191.369 19.7324C192.222 20.2555 193.19 20.5176 194.275 20.5176C194.876 20.5176 195.448 20.3915 195.99 20.1396C196.552 19.8684 197.007 19.4613 197.355 18.9189C197.724 18.3766 197.908 17.6695 197.908 16.7979C197.908 15.4998 197.481 14.4535 196.629 13.6592C195.796 12.8648 194.633 12.1084 193.142 11.3916L191.921 10.8105C190.468 10.1131 189.383 9.34766 188.666 8.51465C187.969 7.66224 187.62 6.57702 187.62 5.25977C187.62 4.23307 187.872 3.32258 188.376 2.52832C188.88 1.73402 189.568 1.11356 190.439 0.667969C191.33 0.222551 192.347 4.27232e-05 193.49 0ZM4.30078 0.407227H7.84668C8.36975 0.40723 8.98032 0.426098 9.67773 0.464844C10.375 0.503599 11.0722 0.600917 11.7695 0.755859C12.4864 0.891478 13.1455 1.13369 13.7461 1.48242C14.366 1.81178 14.8604 2.27642 15.2285 2.87695C15.6159 3.4581 15.8095 4.21378 15.8096 5.14355C15.8096 6.03471 15.5961 6.80013 15.1699 7.43945C14.7631 8.0788 14.2399 8.61185 13.6006 9.03809C12.9806 9.44492 12.3314 9.76459 11.6533 9.99707C12.5833 10.0746 13.4558 10.288 14.2695 10.6367C15.083 10.9854 15.7415 11.5277 16.2451 12.2637C16.7682 12.9805 17.0303 13.9494 17.0303 15.1699C17.0303 16.2935 16.8068 17.2427 16.3613 18.0176C15.9352 18.773 15.3542 19.3738 14.6182 19.8193C13.882 20.2456 13.068 20.5563 12.1768 20.75C11.2855 20.9437 10.3842 21.04 9.47363 21.04H4.30078L0 21.1279V20.4014L0.581055 20.3428C1.25884 20.2653 1.77237 20.1689 2.12109 20.0527C2.4892 19.9171 2.74133 19.6451 2.87695 19.2383C3.01252 18.812 3.08008 18.124 3.08008 17.1748V4.27246C3.08008 3.30396 3.01251 2.61587 2.87695 2.20898C2.74133 1.80213 2.4892 1.54007 2.12109 1.42383C1.77237 1.28828 1.2589 1.18196 0.581055 1.10449L0 1.0459V0.319336L4.30078 0.407227ZM48.7607 1.0459L48.1797 1.10449C47.5212 1.18196 47.0077 1.28828 46.6396 1.42383C46.2715 1.54007 46.0194 1.80213 45.8838 2.20898C45.7482 2.61587 45.6807 3.30395 45.6807 4.27246V17.1748C45.6807 18.124 45.7482 18.812 45.8838 19.2383C46.0194 19.6451 46.2715 19.9171 46.6396 20.0527C47.0077 20.1689 47.5213 20.2653 48.1797 20.3428L48.7607 20.4014V21.1279L44.46 21.04H44.4307L40.1299 21.1279V20.4014L40.7109 20.3428C41.3888 20.2653 41.9023 20.1689 42.251 20.0527C42.6191 19.9171 42.8712 19.6451 43.0068 19.2383C43.1424 18.812 43.21 18.1239 43.21 17.1748V4.27246C43.21 3.30405 43.1424 2.61589 43.0068 2.20898C42.8712 1.80213 42.6191 1.54007 42.251 1.42383C41.9023 1.28823 41.3889 1.18198 40.7109 1.10449L40.1299 1.0459V0.319336L44.4307 0.407227H44.46L48.7607 0.319336V1.0459ZM70.7295 2.64453L71.4561 6.21875L70.8164 6.39355C70.3709 5.27009 69.9548 4.32077 69.5674 3.5459C69.1993 2.77102 68.7634 2.18924 68.2598 1.80176C67.756 1.3949 67.087 1.19141 66.2539 1.19141H61.9531V17.1748C61.9531 18.1239 62.0306 18.812 62.1855 19.2383C62.3599 19.6451 62.6607 19.9171 63.0869 20.0527C63.5131 20.1689 64.114 20.2653 64.8887 20.3428L65.5273 20.4014V21.1279L60.791 21.04L55.9082 21.1279V20.4014L56.5479 20.3428C57.3421 20.2653 57.9428 20.169 58.3496 20.0527C58.7758 19.9171 59.0667 19.6451 59.2217 19.2383C59.396 18.812 59.4834 18.1239 59.4834 17.1748V1.19141H55.3857C54.4945 1.19141 53.7868 1.36611 53.2637 1.71484C52.7601 2.04421 52.3142 2.58636 51.9268 3.3418C51.5587 4.09737 51.1229 5.10498 50.6191 6.36426L50.0088 6.21875L50.7354 2.64453L51.0547 0.319336L59.3379 0.407227H62.0986L70.4102 0.319336L70.7295 2.64453ZM77.0107 0.407227H80.5566C81.0797 0.407231 81.6903 0.426099 82.3877 0.464844C83.085 0.503601 83.7822 0.600916 84.4795 0.755859C85.1963 0.891478 85.8555 1.13369 86.4561 1.48242C87.0759 1.81178 87.5704 2.27643 87.9385 2.87695C88.3259 3.4581 88.5195 4.21379 88.5195 5.14355C88.5195 6.0347 88.3061 6.80013 87.8799 7.43945C87.473 8.0788 86.9499 8.61185 86.3105 9.03809C85.6906 9.44493 85.0414 9.76459 84.3633 9.99707C85.2932 10.0746 86.1658 10.288 86.9795 10.6367C87.7929 10.9854 88.4515 11.5277 88.9551 12.2637C89.4782 12.9805 89.7402 13.9494 89.7402 15.1699C89.7402 16.2935 89.5168 17.2427 89.0713 18.0176C88.6451 18.773 88.0641 19.3738 87.3281 19.8193C86.5919 20.2456 85.7779 20.5563 84.8867 20.75C83.9955 20.9437 83.0942 21.04 82.1836 21.04H77.0107L72.71 21.1279V20.4014L73.291 20.3428C73.9688 20.2653 74.4823 20.1689 74.8311 20.0527C75.1992 19.9171 75.4513 19.6451 75.5869 19.2383C75.7225 18.812 75.79 18.124 75.79 17.1748V4.27246C75.79 3.30397 75.7225 2.61588 75.5869 2.20898C75.4513 1.80213 75.1992 1.54007 74.8311 1.42383C74.4823 1.28828 73.9689 1.18196 73.291 1.10449L72.71 1.0459V0.319336L77.0107 0.407227ZM100.741 0.988281L100.276 1.0459C99.7145 1.10402 99.2778 1.19137 98.9678 1.30762C98.6773 1.42392 98.4746 1.67614 98.3584 2.06348C98.2422 2.43153 98.1836 3.05123 98.1836 3.92285V16.042C98.1836 16.9911 98.2323 17.7756 98.3291 18.3955C98.4453 19.0154 98.7452 19.4711 99.2295 19.7617C99.7138 20.0523 100.499 20.1973 101.584 20.1973H103.764C105.449 20.1972 106.659 19.7515 107.396 18.8604C108.151 17.9498 108.597 16.6424 108.732 14.9375H109.372L109.081 21.1279L96.9336 21.04L92.6328 21.1279V20.4014L93.2139 20.3428C93.8916 20.2653 94.4052 20.1689 94.7539 20.0527C95.122 19.9365 95.3741 19.6645 95.5098 19.2383C95.6453 18.812 95.7129 18.124 95.7129 17.1748V4.27246C95.7129 3.30395 95.6453 2.61587 95.5098 2.20898C95.3741 1.78275 95.122 1.51078 94.7539 1.39453C94.4052 1.25901 93.8916 1.16259 93.2139 1.10449L92.6328 1.0459V0.319336L96.9922 0.407227L100.741 0.319336V0.988281ZM184.119 1.0459L183.538 1.10449C182.879 1.18199 182.365 1.28821 181.997 1.42383C181.629 1.54013 181.378 1.80227 181.242 2.20898C181.107 2.61587 181.038 3.30393 181.038 4.27246V17.1748C181.038 18.124 181.107 18.812 181.242 19.2383C181.378 19.6644 181.629 19.9364 181.997 20.0527C182.365 20.169 182.879 20.2653 183.538 20.3428L184.119 20.4014V21.1279L179.818 21.04L175.488 21.1279V20.4014L176.069 20.3428C176.747 20.2653 177.261 20.169 177.609 20.0527C177.977 19.9365 178.23 19.6645 178.365 19.2383C178.501 18.812 178.568 18.1239 178.568 17.1748V2.2373L169.966 21.04H169.414L161.916 2.52832V17.9893C161.916 18.609 161.994 19.0739 162.148 19.3838C162.303 19.6938 162.556 19.9171 162.904 20.0527C163.272 20.1689 163.776 20.2653 164.415 20.3428L164.997 20.4014V21.1279L161.306 21.04L157.818 21.1279V20.4014L158.399 20.3428C159.078 20.2653 159.592 20.169 159.94 20.0527C160.308 19.9171 160.56 19.6451 160.695 19.2383C160.831 18.812 160.899 18.124 160.899 17.1748V4.27246C160.899 3.30391 160.831 2.61587 160.695 2.20898C160.56 1.80224 160.308 1.54012 159.94 1.42383C159.592 1.28821 159.078 1.18199 158.399 1.10449L157.818 1.0459V0.319336L162.119 0.407227H163.747L170.664 17.1748L178.307 0.407227H180.051L184.119 0.319336V1.0459ZM122.286 0.87207C120.62 0.87207 119.254 1.2692 118.188 2.06348C117.142 2.83844 116.377 3.96213 115.893 5.43457C115.408 6.88752 115.166 8.63096 115.166 10.665C115.166 12.6993 115.408 14.4533 115.893 15.9258C116.377 17.3787 117.142 18.5026 118.188 19.2969C119.254 20.0911 120.62 20.4883 122.286 20.4883C123.972 20.4882 125.338 20.0912 126.384 19.2969C127.43 18.5026 128.195 17.3788 128.68 15.9258C129.164 14.4533 129.406 12.6993 129.406 10.665C129.406 8.63104 129.164 6.88748 128.68 5.43457C128.195 3.96226 127.43 2.83844 126.384 2.06348C125.338 1.26918 123.972 0.872119 122.286 0.87207ZM146.068 0.87207C144.402 0.87207 143.036 1.26914 141.971 2.06348C140.925 2.83844 140.159 3.96216 139.675 5.43457C139.191 6.8875 138.948 8.631 138.948 10.665C138.948 12.6993 139.19 14.4533 139.675 15.9258C140.159 17.3788 140.925 18.5026 141.971 19.2969C143.036 20.0912 144.402 20.4883 146.068 20.4883C147.754 20.4883 149.12 20.0912 150.166 19.2969C151.212 18.5026 151.978 17.3788 152.462 15.9258C152.946 14.4533 153.188 12.6993 153.188 10.665C153.188 8.631 152.946 6.8875 152.462 5.43457C151.978 3.96217 151.212 2.83844 150.166 2.06348C149.12 1.26914 147.754 0.872074 146.068 0.87207ZM5.43457 17.291C5.43457 18.4535 5.62814 19.2386 6.01562 19.6455C6.42248 20.033 7.03297 20.2266 7.84668 20.2266H9.47363C10.4423 20.2266 11.2851 20.0905 12.002 19.8193C12.7381 19.5481 13.3 19.0546 13.6875 18.3379C14.0943 17.6017 14.2978 16.5553 14.2979 15.1992C14.2979 13.8818 14.0755 12.8931 13.6299 12.2344C13.1843 11.5758 12.5061 11.1399 11.5957 10.9268C10.6851 10.7136 9.53166 10.6074 8.13672 10.6074H5.43457V17.291ZM78.1445 17.291C78.1445 18.4535 78.3381 19.2386 78.7256 19.6455C79.1324 20.033 79.7429 20.2266 80.5566 20.2266H82.1836C83.1522 20.2266 83.9951 20.0905 84.7119 19.8193C85.448 19.5481 86.01 19.0546 86.3975 18.3379C86.8043 17.6017 87.0078 16.5553 87.0078 15.1992C87.0078 13.8818 86.7855 12.8931 86.3398 12.2344C85.8943 11.5758 85.2161 11.1399 84.3057 10.9268C83.3951 10.7136 82.2416 10.6074 80.8467 10.6074H78.1445V17.291ZM25.4736 10.2002H27.915C29.7745 10.2002 31.0724 9.82272 31.8086 9.06738C32.5642 8.3118 32.9424 7.17816 32.9424 5.66699C32.9424 4.2333 32.6029 3.12848 31.9248 2.35352C31.2466 1.55948 30.0552 1.16211 28.3506 1.16211H25.4736V10.2002ZM5.43457 9.79395H9.2998C10.5009 9.7939 11.4312 9.40578 12.0898 8.63086C12.7677 7.85589 13.1064 6.69325 13.1064 5.14355C13.1064 4.03948 12.9326 3.20633 12.584 2.64453C12.2352 2.08268 11.731 1.70448 11.0723 1.51074C10.433 1.31707 9.64845 1.22073 8.71875 1.2207H5.43457V9.79395ZM78.1445 9.79395H82.0098C83.2109 9.7939 84.1411 9.40578 84.7998 8.63086C85.4777 7.85589 85.8164 6.69324 85.8164 5.14355C85.8164 4.03949 85.6426 3.20633 85.2939 2.64453C84.9452 2.08268 84.4409 1.70448 83.7822 1.51074C83.143 1.31706 82.3584 1.22073 81.4287 1.2207H78.1445V9.79395Z"
							fill="var(--color-primary)"
						/>
					</svg>
				</span>
				<span className={styles["c-about"]}>
					We specialise in high-quality pond and aquarium supplies for everyone from seasoned aquatic
					enthusiasts to complete beginners.
				</span>
			</div>
			<div ref={el} className={styles["canvas"]}></div>
		</div>
	);
}
